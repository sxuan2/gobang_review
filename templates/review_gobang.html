<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­æ£‹å¤ç›˜æ’­æ”¾å™¨</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .header { width: 100%; max-width: 900px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        #main-layout { display: flex; gap: 20px; max-width: 950px; width: 100%; flex-wrap: wrap; justify-content: center; }
        
        /* æ£‹ç›˜æ ·å¼ */
        #canvas-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        canvas { background-color: #DEB887; border: 2px solid #5c3a21; cursor: default; }

        /* æ§åˆ¶é¢æ¿ */
        #controls { width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .info-box { background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin-bottom: 20px; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 10px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; border-radius: 4px; background: #fff; transition: 0.2s; }
        button:hover:not(:disabled) { background: #e9ecef; border-color: #adb5bd; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #007bff; color: white; border: none; grid-column: span 2; }
        .btn-primary:hover { background: #0056b3; }

        #progress-bar { width: 100%; margin: 15px 0; cursor: pointer; }
        #step-label { font-size: 18px; font-weight: bold; text-align: center; margin: 10px 0; color: #2c3e50; }

        .user-bar {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 14px;
            color: #555;
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 20px;
        }
        .user-bar a {
            text-decoration: none;
            margin-left: 10px;
            color: #007bff;
            font-weight: bold;
        }
        .user-bar a.danger { color: #dc3545; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0;">ğŸ¬ äº”å­æ£‹æˆ˜æœ¯å¤ç›˜</h2>
    </div>

    <div class="user-bar">
        ğŸ‘¤ {{ current_user.username }}
        {% if current_user.is_admin %}
            <a href="/admin_panel">âš™ï¸ åå°ç®¡ç†</a>
        {% endif %}
        <a href="/" style="text-decoration:none; color:#007bff;">è¿”å›é—¨æˆ·</a>
        <a href="/logout" class="danger">é€€å‡ºç™»å½•</a>
    </div>

    <div id="main-layout">
        <div id="canvas-container">
            <canvas id="reviewCanvas" width="600" height="600"></canvas>
        </div>

        <div id="controls">
            <div class="info-box">
                <div style="font-weight:bold; margin-bottom:10px;">ğŸ“‚ å¯¼å…¥æ£‹è°±æ–‡ä»¶</div>
                <input type="file" id="fileInput" accept=".json" style="font-size:12px; width:100%;">
                <div id="meta-info" style="margin-top:10px; font-size:13px; color:#666;">è¯·ä¸Šä¼ å¯¼å‡ºçš„ JSON è®°å½•</div>
            </div>

            <div id="step-label">0 / 0</div>
            <input type="range" id="progress-bar" min="0" max="0" value="0">

            <div class="btn-grid">
                <button onclick="changeStep(-999)">â® èµ·å§‹</button>
                <button onclick="changeStep(999)">â­ ç»“æœ</button>
                <button onclick="changeStep(-1)">â—€ ä¸Šä¸€æ­¥</button>
                <button onclick="changeStep(1)">ä¸‹ä¸€æ­¥ â–¶</button>
                <button id="playBtn" class="btn-primary" onclick="togglePlay()">â–¶ è‡ªåŠ¨æ’­æ”¾</button>
            </div>

            <div style="margin-top:20px; font-size:12px; color:#999; text-align:center;">
                * é€Ÿåº¦æ§åˆ¶: 
                <select id="speedSelect" style="font-size:12px;">
                    <option value="1500">æ…¢é€Ÿ</option>
                    <option value="800" selected>æ­£å¸¸</option>
                    <option value="400">å¿«é€Ÿ</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('reviewCanvas');
        const ctx = canvas.getContext('2d');
        const GRID_SIZE = 15;
        const CELL_SIZE = 600 / GRID_SIZE;
        const OFFSET = CELL_SIZE / 2;

        let moves = [];
        let currentIdx = 0;
        let playTimer = null;

        // --- æ ¸å¿ƒç»˜å›¾ ---
        function render() {
            // 1. ç»˜åˆ¶æ£‹ç›˜
            ctx.clearRect(0, 0, 600, 600);
            ctx.strokeStyle = "#8B4513";
            ctx.lineWidth = 1;
            for (let i = 0; i < GRID_SIZE; i++) {
                ctx.beginPath();
                ctx.moveTo(OFFSET, OFFSET + i * CELL_SIZE); ctx.lineTo(600 - OFFSET, OFFSET + i * CELL_SIZE); ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(OFFSET + i * CELL_SIZE, OFFSET); ctx.lineTo(OFFSET + i * CELL_SIZE, 600 - OFFSET); ctx.stroke();
            }

            // 2. ç»˜åˆ¶ç›´åˆ° currentIdx çš„æ£‹å­
            for (let i = 0; i < currentIdx; i++) {
                const m = moves[i];
                const sx = OFFSET + m.x * CELL_SIZE;
                const sy = OFFSET + m.y * CELL_SIZE;

                ctx.beginPath();
                ctx.arc(sx, sy, CELL_SIZE * 0.4, 0, Math.PI * 2);
                ctx.fillStyle = m.color === 1 ? "#000" : "#fff";
                ctx.fill();
                
                // ç»™æœ€åä¸€æ‰‹åŠ çº¢æ¡†æ ‡è®°
                if (i === currentIdx - 1) {
                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(sx - CELL_SIZE*0.2, sy - CELL_SIZE*0.2, CELL_SIZE*0.4, CELL_SIZE*0.4);
                }
            }

            // 3. æ›´æ–° UI
            document.getElementById('step-label').innerText = `${currentIdx} / ${moves.length}`;
            document.getElementById('progress-bar').value = currentIdx;
        }

        // --- æ–‡ä»¶å¤„ç† ---
        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    moves = data.moves || [];
                    currentIdx = 0;
                    document.getElementById('progress-bar').max = moves.length;
                    document.getElementById('meta-info').innerText = `å¯¹å±€: ${data.game_meta.name || 'æœªå‘½å'}\næ—¶é—´: ${data.game_meta.start_time}`;
                    render();
                } catch(err) {
                    alert("æ£‹è°±æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼");
                }
            };
            reader.readAsText(file);
        };

        // --- æ’­æ”¾æ§åˆ¶ ---
        function changeStep(delta) {
            if (delta === 999) currentIdx = moves.length;
            else if (delta === -999) currentIdx = 0;
            else currentIdx = Math.min(moves.length, Math.max(0, currentIdx + delta));
            render();
        }

        document.getElementById('progress-bar').oninput = function() {
            currentIdx = parseInt(this.value);
            render();
        };

        function togglePlay() {
            const btn = document.getElementById('playBtn');
            if (playTimer) {
                clearInterval(playTimer);
                playTimer = null;
                btn.innerText = "â–¶ è‡ªåŠ¨æ’­æ”¾";
            } else {
                if (currentIdx >= moves.length) currentIdx = 0;
                btn.innerText = "â¸ åœæ­¢æ’­æ”¾";
                const speed = parseInt(document.getElementById('speedSelect').value);
                playTimer = setInterval(() => {
                    if (currentIdx < moves.length) {
                        currentIdx++;
                        render();
                    } else {
                        togglePlay(); // æ’­æ”¾å®Œè‡ªåŠ¨åœæ­¢
                    }
                }, speed);
            }
        }

        render(); // åˆå§‹æ¸²æŸ“ç©ºæ£‹ç›˜
    </script>
</body>
</html>